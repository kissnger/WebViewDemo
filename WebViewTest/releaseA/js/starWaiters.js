require(["config"],function(){require(["libs/pjs","libs/chart","libs/utily","services/dateService","libs/dateChange","zepto","libs/artTemplate","libs/sidebar"],function(a,b,c,d,e,f,g){function h(a,c,d){if(j&&j.destroy(),a){var e=[],g=0,h=0;if(a.length){for(var i=0;i<a.length;i+=1)if("money"===c?(g=0===d?0:a[i].consumption/d,h+=g,e.push({value:100*g,color:n[i],label:a[i].waiterName})):(g=0===d?0:a[i].tableNum/d,h+=g,e.push({value:100*g,color:n[i],label:a[i].waiterName})),i>=4){a.length>5&&e.push({value:100*(1-h),color:n[5],label:"其他"});break}f(".canvas-img").hide(),j=new b(l).Doughnut(e,{animationSteps:20,segmentShowStroke:!1,percentageInnerCutout:65,tooltipFontFamily:"'微软雅黑', 'Helvetica', 'Helvetica Neue'",tooltipFontSize:20,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value.toFixed(2) %>%",legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<segments.length; i++){%><li class="lengend-item" ><span style="background-color:<%=segments[i].fillColor%>"></span><%if(segments[i].label){%><%=segments[i].label%> : <%=segments[i].value.toFixed(2)%>% <%}%></li><%}%></ul>',onAnimationComplete:function(){1===e.length&&f(".canvas-img").show()}}),document.getElementById("js-legend").innerHTML=j.generateLegend()}}}function i(a){function b(){if(f(".no-datas").hide(),f(".star-waiters-top3").show(),c(),"starMoneyWaiters"==j){for(l="moneyList",m.data.sort(function(a,b){return b.consumption-a.consumption}),i=0,e=0;e<m.data.length;e+=1)i+=m.data[e].consumption;d=g(l,{totalMoney:i,waiterData:m.data}),f(".hint-title").html("总销售额"),f(".hint-count").html("￥"+k(i,2))}else{for(l="tableList",m.data.sort(function(a,b){return b.tableNum-a.tableNum}),i=0,e=0;e<m.data.length;e+=1)i+=m.data[e].tableNum;d=g(l,{totalTable:i,waiterData:m.data}),f(".hint-title").html("总餐台数"),f(".hint-count").html(i)}f(".waiters-detail-ul").html(d),h(m.data,j,i)}function c(){m.data.sort(function(a,b){return a.index-b.index}),d=g("starTop3Waiter",{starData:m.data}),f(".star-topwaiters-ul").html(d)}var d,e,i,j=a.type;if(m.startTime&&a.startTime===m.startTime&&a.unit===m.unit&&a.type===m.type)b();else{var l,n=u[j];n&&n.length>0?(f.extend(m,a),q=a.startTime,m.data=n,b()):(f(".no-datas").show(),f(".star-waiters-top3").hide(),f(".waiters-detail-ul").html(""))}}var j,k=c.toFixed,l=document.getElementById("js_waiters_report").getContext("2d"),m={startTime:0,unit:0,data:[]},n=["#35c8de","#afcf36","#fe9e6d","#e5c71f","#d9faf4","#919191"],o=new Date,p=a.getPathArgument("hotelId"),q=parseInt(sessionStorage.getItem("cur_time"),10)||Date.parse(o.getFullYear()+"/"+(o.getMonth()+1)+"/"+o.getDate()+" 23:59:00"),r=document.querySelector(".px_date_right"),s=document.querySelector(".px_date_left"),t=t=parseInt(sessionStorage.getItem("cur_unit"),10)||1,u={starMoneyWaiters:[{waiterName:"1002",tableNum:9,consumption:183,consumptionText:"183.00",customerNum:9,index:1},{waiterName:"0000",tableNum:3,consumption:180,consumptionText:"180.00",customerNum:3,index:2},{waiterName:"WAITER",tableNum:1,consumption:96,consumptionText:"96.00",customerNum:2,index:3}],starTableWaiters:[{waiterName:"1002",tableNum:9,consumption:183,consumptionText:"183.00",customerNum:9,index:1},{waiterName:"0000",tableNum:3,consumption:180,consumptionText:"180.00",customerNum:3,index:2},{waiterName:"WAITER",tableNum:1,consumption:96,consumptionText:"96.00",customerNum:2,index:3}]};g.helper("format",function(a){return k(a,2)}),d.loadDateValue(),i({hotelId:p,startTime:q,unit:parseInt(sessionStorage.getItem("cur_unit"),10)||t,type:f(".tab-selected").attr("operateType")});var v=document.querySelector(".top-nav").querySelector(".go-directory");v.href=v.href+"?hotelId="+p;var w=document.querySelector(".go-back");w.addEventListener("touchstart",function(){window.location.href="index.html?hotelId="+p},!1),f(".waiters-tab").on("tap",".waiters-tab-item",function(a){f(".waiters-tab-item").removeClass("tab-selected"),f(this).addClass("tab-selected");f(this).attr("operateType");i({hotelId:p,startTime:q,unit:t,type:f(".tab-selected").attr("operateType")})}),r.addEventListener("click",function(){var a=e.date(1);sessionStorage.setItem("cur_time",a),i({hotelId:p,startTime:a,unit:t,type:f(".tab-selected").attr("operateType")})},!1),s.addEventListener("click",function(){var a=e.date(-1);sessionStorage.setItem("cur_time",a),i({hotelId:p,startTime:a,unit:t,type:f(".tab-selected").attr("operateType")})},!1),f(document).on("date",function(a,b,c){t=Number(c),sessionStorage.setItem("cur_unit",c),sessionStorage.setItem("cur_time",b),i({hotelId:p,startTime:b,unit:t,type:f(".tab-selected").attr("operateType")})}),d.subscribeDate(function(a){var b=new Date(a);b.setHours(23,59,0,0),b=b.getTime(),sessionStorage.setItem("cur_time",b),i({hotelId:p,startTime:b,unit:t,type:f(".tab-selected").attr("operateType")})})})});
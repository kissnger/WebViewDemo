define(["zepto","libs/pjs","libs/frame"],function(a,b,c){var d={init:function(){this.getToken()},getToken:function(){function d(){var b="/dxs-web/api/v1/access/auth?accessToken="+h;j&&!isNaN(j)&&(b+="&hotelId="+j),a.ajax({async:!1,url:b,method:"post",dataType:"json",success:function(a){a.status?f(a.data):a.data?f(a.data):e()},error:function(){g()}})}function e(){if(!i)return window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx992d7bb0c6396e81&redirect_uri="+encodeURIComponent(location.origin+location.pathname)+"&response_type=code&scope=snsapi_base&state="+j+"&connect_redirect=1#wechat_redirect",!1;var b="/dxs-web/api/v1/access/handshake?code="+i;j&&!isNaN(j)&&(b+="&hotelId="+j),a.ajax({async:!1,url:b,method:"post",dataType:"json",success:function(a){a.status?f(a.data):a.data?f(a.data):g()},error:function(a){g()}})}function f(a){b.cookie.setCookie("VALIDATE-TOKEN",a.authToken,Number(a.available)-1),b.cookie.setCookie("wuid",a.wcUnionId,Number(a.available)-1),m||history.replaceState(null,"",l.replace("hotelId=auth","hotelId="+a.hotelId))}function g(){b.alert("Oh！糟糕，生意太好了，服务器累晕了",function(){location.reload()},{okText:"刷新试试"})}var h=b.cookie.getCookie("VALIDATE-TOKEN"),i=c.DOM.getPathArgument("code"),j=(b.cookie.getCookie("wuid"),c.DOM.getPathArgument("hotelId")||c.DOM.getPathArgument("state")),k=window.location.href,l=k.replace(/hotelId=[^&]*\b/,"hotelId=auth").replace(/state=[^&]*\b/,"hotelId=auth").replace(/[\?|&]code=[^&]*/,"").replace("html&","html?"),m="/index.html"==location.pathname;""==j&&(l+=(-1==k.indexOf("?")?"?":"&")+"hotelId=auth"),h?d():e()}};return d.init(),d});